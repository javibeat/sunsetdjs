<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AZURE Schedule</title>
  <link rel="stylesheet" href="styles.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&display=swap" rel="stylesheet">
</head>
<body>
  <nav class="navbar">
    <div class="hamburger">
      <div class="bar"></div>
      <div class="bar"></div>
      <div class="bar"></div>
    </div>
    <ul class="nav-menu">
      <li><a href="index.html" class="nav-link">HOME</a></li>
      <li class="venues-item">
        <span class="nav-link venues-toggle">VENUES <i class="fas fa-chevron-down"></i></span>
        <ul class="venues-submenu">
          <li><a href="drift.html" class="nav-link">DRIFT</a></li>
          <li><a href="azure.html" class="nav-link">AZURE</a></li>
          <li><a href="aura.html" class="nav-link">AURA</a></li>
          <li><a href="ammos.html" class="nav-link">AMMOS</a></li>
          <li><a href="baoli.html" class="nav-link">BAOLI</a></li>
        </ul>
      </li>
    </ul>
  </nav>

  <div class="container">
    <h1>AZURE Schedule <span id="current-month"></span></h1>
    <div id="schedule-container">
      <table id="schedule-table">
        <thead>
          <tr>
            <th>DJ</th>
            <th>Monday</th>
            <th>Tuesday</th>
            <th>Wednesday</th>
            <th>Thursday</th>
            <th>Friday</th>
            <th>Saturday</th>
            <th>Sunday</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <div class="share-container">
    <button id="shareButton" class="share-button">
      <i class="fas fa-share-alt"></i> Share Schedule
    </button>
  </div>

  <script>
    async function fetchSchedule() {
      try {
        const SHEET_ID = '1gr_yWuMPAHMUOFo4A3mTin6vqKrlK3CiCsNL98WnMF0';
        const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?sheet=AZURE&tqx=out:json`;
        console.log('Fetching from:', url);

        const response = await fetch(url);
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

        const text = await response.text();
        const jsonText = text.substring(47).slice(0, -2);
        const data = JSON.parse(jsonText);

        const values = data.table.rows.map(row =>
          row.c.map(cell => (cell ? cell.v : ''))
        );
        console.log('Recibidos (sin slice):', values);

        const tableBody = document.querySelector('#schedule-table tbody');
        tableBody.innerHTML = '';

        if (!values || values.length === 0) {
          console.error('No data in response');
          tableBody.innerHTML = '<tr><td colspan="8">No schedule data available.</td></tr>';
          return;
        }

        // Omitir primera fila si es encabezado
        const dataRows = values.slice(1);

        dataRows.forEach(row => {
          if (!row.some(col => String(col).trim() !== '')) return;

          const tr = document.createElement('tr');
          // 8 columnas
          for (let i = 0; i < 8; i++) {
            const td = document.createElement('td');
            const cellValue = row[i] ? row[i] : '—';
            td.textContent = cellValue;

            // Resaltar turnos
            if (i >= 1 && i <= 7 && cellValue !== '—') {
              const timeMatch = cellValue.match(
                /(\d+)(?::(\d+))?(?:\s*(AM|PM))?\s*-\s*(\d+)(?::(\d+))?(?:\s*(AM|PM))?/i
              );
              if (timeMatch) {
                let [ , startH, startM, startAP, endH, endM, endAP ] = timeMatch;
                startH = parseInt(startH || '0', 10);
                endH = parseInt(endH || '0', 10);
                startM = parseInt(startM || '0', 10);
                endM = parseInt(endM || '0', 10);

                // 24h
                if (startAP && startAP.toLowerCase().includes('p') && startH < 12) startH += 12;
                if (endAP && endAP.toLowerCase().includes('p') && endH < 12) endH += 12;
                if (startAP && startAP.toLowerCase().includes('a') && startH === 12) startH = 0;
                if (endAP && endAP.toLowerCase().includes('a') && endH === 12) endH = 0;

                const scheduleStart = startH * 60 + startM;
                const scheduleEnd = endH * 60 + endM;
                const now = new Date();
                const currentTime = now.getHours() * 60 + now.getMinutes();
                const currentDay = now.getDay() || 7;
                if (currentDay === 0) 7;
                const dayIndex = (currentDay === 0) ? 7 : currentDay;

                const isMorning = (startH >= 12 && endH <= 18);
                const isEvening = (startH >= 18 && (endH < 24 || (endH === 23 && endM <= 30)));

                if (i === dayIndex) {
                  if (currentTime >= scheduleStart && currentTime < scheduleEnd) {
                    td.classList.add('current-shift');
                  } else {
                    if (isMorning) td.classList.add('morning-shift');
                    else if (isEvening) td.classList.add('evening-shift');
                  }
                } else {
                  if (isMorning) td.classList.add('morning-shift');
                  else if (isEvening) td.classList.add('evening-shift');
                }
              }
            }
            tr.appendChild(td);
          }
          tableBody.appendChild(tr);
        });
      } catch (error) {
        console.error('Error fetching schedule:', error);
        document.querySelector('#schedule-table tbody').innerHTML =
          '<tr><td colspan="8">Failed to load schedule.</td></tr>';
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      fetchSchedule();
      document.getElementById('current-month').textContent = new Date()
        .toLocaleString('en-US', { month: 'long' })
        .toUpperCase();

      const hamburger = document.querySelector('.hamburger');
      const navMenu = document.querySelector('.nav-menu');
      const venuesToggle = document.querySelector('.venues-toggle');

      hamburger.addEventListener('click', () => {
        hamburger.classList.toggle('active');
        navMenu.classList.toggle('active');
      });

      venuesToggle.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        venuesToggle.parentElement.classList.toggle('submenu-active');
      });
    });

    document.getElementById('shareButton').addEventListener('click', async () => {
      try {
        const url = window.location.href;
        await navigator.share({
          title: 'AZURE DJ Schedule',
          text: `Check out the DJ schedule for AZURE - ${document.getElementById('current-month').textContent}`,
          url: url
        });
      } catch (err) {
        navigator.clipboard.writeText(window.location.href);
        alert('Schedule link copied to clipboard!');
      }
    });
  </script>
</body>
</html>